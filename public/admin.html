<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¾Œå°ç®¡ç† - ç™»å…¥</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* * =================================
        * åŸºæœ¬æ¨£å¼ & ç™»å…¥ç•«é¢
        * =================================
        */
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            text-align: center;
            background: #f0f4f8;
            margin: 0;
            padding: 20px;
            /* ã€ä¿®æ”¹ã€‘ è®“ padding åœ¨æ‰‹æ©Ÿä¸Šå°ä¸€é» */
            padding-top: 30px;
        }

        #login-container {
            max-width: 400px;
            /* ã€ä¿®æ”¹ã€‘ å¢åŠ  width: 90% ä»¥é©æ‡‰å°è¢å¹• */
            width: 90%;
            box-sizing: border-box;
            margin: 50px auto; /* æ¸›å°‘ margin */
            padding: 30px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #login-container h1 {
            font-size: 2.2rem;
            color: #dc2626;
            margin-top: 0;
            margin-bottom: 25px;
        }

        #login-container input {
            font-size: 1.2rem;
            padding: 12px;
            width: 100%;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            text-align: left;
        }

        #login-container button {
            font-size: 1.2rem;
            padding: 12px 20px;
            margin-top: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            background-color: #2563eb;
            width: 100%;
        }

        #login-container button:hover {
            opacity: 0.9;
        }

        #login-error {
            color: #dc2626;
            margin-top: 15px;
            height: 1.2rem;
        }

        /* * =================================
        * å¾Œå°æ§åˆ¶å° (é è¨­éš±è—)
        * =================================
        */
        #admin-panel {
            display: none;
            padding-top: 0; /* ç™»å…¥å¾Œ padding è¨­ç‚º 0 */
            max-width: 600px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…é›»è…¦ä¸Šå¤ªå¯¬ */
            margin: 0 auto; /* ç½®ä¸­ */
        }

        /* æ¨™é¡Œ */
        #admin-panel h1 {
            font-size: 3rem;
            color: #dc2626;
            margin-bottom: 30px;
        }

        /* ç›®å‰è™Ÿç¢¼é¡¯ç¤º */
        #number {
            font-size: 5rem;
            color: #2563eb;
            margin: 20px 0;
        }

        /* ã€ä¿®æ”¹ã€‘
        ä½¿ç”¨ Flexbox è®“æ’ç‰ˆæ›´éˆæ´» */
        .control-group {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column; /* é è¨­å‚ç›´å †ç–Š */
            align-items: center; /* æ°´å¹³ç½®ä¸­ */
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
        }

        /* é‡å° "ä¸Šä¸€è™Ÿ/ä¸‹ä¸€è™Ÿ" çš„ç¾¤çµ„ï¼Œåœ¨å¯¬è¢å¹•æ™‚ä¸¦æ’ */
        .control-group.button-row {
            flex-direction: row; /* æ°´å¹³æ’åˆ— */
            justify-content: center; /* æ°´å¹³ç½®ä¸­ */
        }

        .control-group label {
            display: block;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 8px;
            font-weight: bold;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            font-size: 1.2rem;
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            min-width: 120px;
            width: 90%; /* è®“æŒ‰éˆ•åœ¨æ‰‹æ©Ÿä¸Šè®Šå¯¬ */
            max-width: 300px; /* ä½†ä¸è¦ç„¡é™å¯¬ */
        }

        /* æ°´å¹³æ’åˆ—çš„æŒ‰éˆ•ï¼Œå¯¬åº¦è¨­ç‚º auto */
        .control-group.button-row button {
            width: auto;
            min-width: 120px;
        }

        #prev {
            background-color: #ef4444;
        }
        #next {
            background-color: #10b981;
        }
        #setNumber {
            background-color: #2563eb;
        }
        #setText {
            background-color: #f59e0b;
        }
        #savePassedNumbers {
            background-color: #0891b2;
        }

        /* è¼¸å…¥æ¡†èˆ‡æ–‡å­—æ¡† */
        input,
        textarea {
            font-size: 1.2rem;
            padding: 8px;
            width: 90%;
            max-width: 300px;
            text-align: center;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-top: 10px;
            box-sizing: border-box;
        }

        textarea {
            height: 80px;
            text-align: left;
            padding: 10px;
        }

        /* é‡ç½®å€åŸŸ */
        .reset-zone {
            margin-top: 40px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }

        /* ã€æ–°å¢ã€‘é‡ç½®å€æ¨™é¡Œ */
        .reset-zone h3 {
            color: #555;
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* ã€æ–°å¢ã€‘å–®é …é‡ç½®æŒ‰éˆ•çš„æ¨£å¼ */
        .btn-reset-single {
            background-color: #d97706; /* ç¥ç€è‰² (è­¦å‘Š) */
            font-size: 1rem; /* å­—é«”ç¨å° */
            padding: 8px 15px;
            width: auto;
        }
        .btn-reset-single:hover {
            opacity: 0.9;
        }

        /* ã€ä¿®æ”¹ã€‘è®“ã€Œé‡ç½®æ‰€æœ‰ã€æŒ‰éˆ•èˆ‡ä¸Šæ–¹ä¿æŒè·é›¢ */
        #resetAll {
            background-color: #7f1d1d;
            margin-top: 20px; /* èˆ‡å–®é …é‡ç½®æŒ‰éˆ•åˆ†éš” */
        }

        /*
        ============================================= */
        /* ===        ğŸ‘‡ğŸ‘‡ Media Query ğŸ‘‡ğŸ‘‡         === */
        /*
        ============================================= */
        @media (max-width: 768px) {
            body {
                padding: 20px 10px; /* æ‰‹æ©Ÿä¸Š padding æ›´å° */
            }

            #login-container {
                margin: 30px auto; /* æ‰‹æ©Ÿä¸Šé‚Šè·æ›´å° */
                padding: 20px;
            }

            #admin-panel h1 {
                font-size: 2.2rem; /* æ¨™é¡Œç¸®å° */
            }

            #number {
                font-size: 4rem; /* è™Ÿç¢¼ç¸®å° */
            }
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h1>å¾Œå°ç®¡ç†ç™»å…¥</h1>
        <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" />
        <button id="login-button">ç™»å…¥</button>
        <p id="login-error"></p>
    </div>

    <div id="admin-panel">
        <h1>ç›®å‰è™Ÿç¢¼ï¼š<span id="number">0</span></h1>

        <div class="control-group button-row">
            <button id="prev">ä¸Šä¸€è™Ÿ</button>
            <button id="next">ä¸‹ä¸€è™Ÿ</button>
        </div>

        <div class="control-group">
            <input type="number" id="manualNumber" placeholder="è¼¸å…¥è™Ÿç¢¼" />
            <button id="setNumber">è¨­å®šè™Ÿç¢¼</button>
        </div>

        <div class="control-group">
            <textarea id="customText" placeholder="è¼¸å…¥ä¸­æ–‡æ–‡å­—ï¼Œå¯æ›è¡Œ"></textarea>
            <button id="setText">è¨­å®šæ–‡å­—</button>
        </div>

        <div class="control-group">
            <label for="passedNumbersInput">æ‰‹å‹•ç·¨è¼¯éè™Ÿåˆ—è¡¨ (ç”¨é€—è™Ÿ,åˆ†éš”)</label>
            <textarea id="passedNumbersInput" placeholder="ä¾‹å¦‚ï¼š 5, 8, 12"></textarea>
            <button id="savePassedNumbers">å„²å­˜éè™Ÿåˆ—è¡¨</button>
        </div>

        <div class="reset-zone">
            <h3>--- é‡ç½®é¸é … ---</h3>
            <div class="control-group button-row">
                <button id="resetNumber" class="btn-reset-single">é‡ç½®è™Ÿç¢¼ (æ­¸0)</button>
                <button id="resetText" class="btn-reset-single">é‡ç½®æ–‡å­—</button>
                <button id="resetPassed" class="btn-reset-single">é‡ç½®éè™Ÿåˆ—è¡¨</button>
            </div>
            <button id="resetAll">ğŸ’¥ é‡ç½®æ‰€æœ‰ (å…¨éƒ¨æ­¸0)</button>
        </div>

    </div>

    <script>
        // --- å…ƒç´ æŠ“å– (ç™»å…¥) ---
        const loginContainer = document.getElementById("login-container");
        const adminPanel = document.getElementById("admin-panel");
        const passwordInput = document.getElementById("password-input");
        const loginButton = document.getElementById("login-button");
        const loginError = document.getElementById("login-error");

        // --- å…ƒç´ æŠ“å– (æ§åˆ¶å°) ---
        const numberEl = document.getElementById("number");
        const passedNumbersInputEl = document.getElementById("passedNumbersInput");

        // --- å…¨åŸŸè®Šæ•¸ ---
        let token = "";

        // --- Socket.io ---
        const socket = io({ autoConnect: false });

        // --- é¡¯ç¤º/éš±è— ---
        function showLogin() {
            loginContainer.style.display = "block";
            adminPanel.style.display = "none";
            localStorage.removeItem("adminToken");
            document.title = "å¾Œå°ç®¡ç† - ç™»å…¥";
        }

        function showPanel() {
            loginContainer.style.display = "none";
            adminPanel.style.display = "block";
            document.title = "å¾Œå°ç®¡ç† - æ§åˆ¶å°";
            socket.connect();
        }

        // --- é©—è­‰ Token ---
        async function checkToken(tokenToCheck) {
            if (!tokenToCheck) return false;
            try {
                const res = await fetch("/check-token", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token: tokenToCheck }),
                });
                return res.ok;
            } catch (err) {
                console.error("checkToken å¤±æ•—:", err);
                return false;
            }
        }

        // --- ç™»å…¥é‚è¼¯ ---
        async function attemptLogin(tokenToCheck) {
            loginError.textContent = "é©—è­‰ä¸­...";
            const isValid = await checkToken(tokenToCheck);

            if (isValid) {
                token = tokenToCheck;
                showPanel();
            } else {
                loginError.textContent = "å¯†ç¢¼éŒ¯èª¤";
                showLogin();
            }
        }

        // --- é é¢è¼‰å…¥ ---
        document.addEventListener("DOMContentLoaded", () => {
            showLogin();
        });

        // --- ç™»å…¥æŒ‰éˆ•äº‹ä»¶ ---
        loginButton.addEventListener("click", () => {
            attemptLogin(passwordInput.value);
        });
        passwordInput.addEventListener("keyup", (event) => {
            if (event.key === "Enter") {
                attemptLogin(passwordInput.value);
            }
        });

        //
        // =============================================
        //      æ§åˆ¶å°é‚è¼¯
        // =============================================
        //

        // --- Socket ç›£è½å™¨ ---
        socket.on("connect", () => {
            console.log("Socket.io å·²é€£æ¥");
        });
        socket.on("update", (num) => (numberEl.textContent = num));
        socket.on("updatePassed", (numbers) => {
            if (numbers && Array.isArray(numbers)) {
                passedNumbersInputEl.value = numbers.join(", ");
            } else {
                passedNumbersInputEl.value = "";
            }
        });

        // --- API è«‹æ±‚å‡½å¼ ---
        async function apiRequest(endpoint, body) {
            try {
                const res = await fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ...body, token }), // æ³¨å…¥ token
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    if (res.status === 403) {
                        alert("å¯†ç¢¼é©—è­‰å¤±æ•—æˆ– Token å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
                        showLogin();
                    } else {
                        alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + (errorData.error || "æœªçŸ¥éŒ¯èª¤"));
                    }
                    return false;
                }
                return true;
            } catch (err) {
                alert("ç¶²è·¯é€£ç·šå¤±æ•—æˆ–ä¼ºæœå™¨ç„¡å›æ‡‰ï¼š" + err.message);
                return false;
            }
        }

        // --- æ§åˆ¶å°æŒ‰éˆ•åŠŸèƒ½ ---

        async function changeNumber(direction) {
            await apiRequest("/change-number", { direction });
        }

        async function setNumber() {
            const num = document.getElementById("manualNumber").value;
            if (num === "") return;
            const success = await apiRequest("/set-number", { number: num });
            if (success) {
                document.getElementById("manualNumber").value = "";
            }
        }

        async function setText() {
            const text = document.getElementById("customText").value;
            const success = await apiRequest("/set-text", { text });
            if (success) {
                document.getElementById("customText").value = "";
            }
        }

        async function savePassedNumbers() {
            const text = passedNumbersInputEl.value;
            const numbersArray = text
                .split(",")
                .map((n) => n.trim())
                .filter((n) => n.length > 0)
                .map((n) => Number(n));

            const success = await apiRequest("/set-passed-numbers", {
                numbers: numbersArray,
            });
            if (success) {
                alert("éè™Ÿåˆ—è¡¨å·²å„²å­˜ã€‚");
            }
        }

        // ã€æ–°å¢ã€‘é‡ç½®è™Ÿç¢¼ (æ­¸ 0)
        async function resetNumber() {
            if (!confirm("ç¢ºå®šè¦å°‡ã€Œç›®å‰è™Ÿç¢¼ã€é‡ç½®ç‚º 0 å—ï¼Ÿ (æœƒå°‡ç¾æœ‰è™Ÿç¢¼åŠ å…¥éè™Ÿåˆ—è¡¨)")) {
                return;
            }
            // é‡è¤‡ä½¿ç”¨ /set-number API
            const success = await apiRequest("/set-number", { number: 0 });
            if (success) {
                document.getElementById("manualNumber").value = "";
                alert("è™Ÿç¢¼å·²é‡ç½®ç‚º 0ã€‚");
            }
        }

        // ã€æ–°å¢ã€‘é‡ç½®æ–‡å­— (æ¸…ç©º)
        async function resetText() {
            if (!confirm("ç¢ºå®šè¦æ¸…ç©ºã€Œæç¤ºæ–‡å­—ã€å—ï¼Ÿ")) {
                return;
            }
            // é‡è¤‡ä½¿ç”¨ /set-text API
            const success = await apiRequest("/set-text", { text: "" });
            if (success) {
                document.getElementById("customText").value = "";
                alert("æ–‡å­—å·²æ¸…ç©ºã€‚");
            }
        }

        // ã€æ–°å¢ã€‘é‡ç½®éè™Ÿåˆ—è¡¨ (æ¸…ç©º)
        async function resetPassed() {
            if (!confirm("ç¢ºå®šè¦æ¸…ç©ºã€Œå·²å«è™Ÿç¢¼(éè™Ÿ)ã€åˆ—è¡¨å—ï¼Ÿ")) {
                return;
            }
            // é‡è¤‡ä½¿ç”¨ /set-passed-numbers API
            const success = await apiRequest("/set-passed-numbers", { numbers: [] });
            if (success) {
                alert("éè™Ÿåˆ—è¡¨å·²æ¸…ç©ºã€‚");
            }
        }


        async function resetAll() {
            if (
                !confirm(
                    "ç¢ºå®šè¦å°‡ç›®å‰è™Ÿç¢¼ã€æç¤ºæ–‡å­—ã€å·²å«è™Ÿç¢¼åˆ—è¡¨å…¨éƒ¨é‡ç½®å—ï¼Ÿ"
                )
            ) {
                return;
            }
            const success = await apiRequest("/reset", {});
            if (success) {
                document.getElementById("manualNumber").value = "";
                document.getElementById("customText").value = "";
                alert("å·²å…¨éƒ¨é‡ç½®ã€‚");
            }
        }

        // --- ç¶å®šæŒ‰éˆ•äº‹ä»¶ ---
        document.getElementById("next").onclick = () => changeNumber("next");
        document.getElementById("prev").onclick = () => changeNumber("prev");
        document.getElementById("setNumber").onclick = setNumber;
        document.getElementById("setText").onclick = setText;
        document.getElementById("savePassedNumbers").onclick = savePassedNumbers;

        // ç¶å®šé‡ç½®æŒ‰éˆ•
        document.getElementById("resetNumber").onclick = resetNumber;
        document.getElementById("resetText").onclick = resetText;
        document.getElementById("resetPassed").onclick = resetPassed;
        document.getElementById("resetAll").onclick = resetAll;

    </script>
</body>
</html>
