<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¾Œå°ç®¡ç† - ç™»å…¥</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- 1. åŸºç¤ & ç™»å…¥é  --- */
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            text-align: center;
            background: #f0f4f8;
            margin: 0;
            padding: 20px;
            padding-top: 30px;
        }

        #login-container {
            max-width: 400px;
            width: 90%;
            box-sizing: border-box;
            margin: 50px auto;
            padding: 30px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #login-container h1 {
            font-size: 2.2rem;
            color: #dc2626;
            margin-top: 0;
            margin-bottom: 25px;
        }

        #login-container input {
            font-size: 1.2rem;
            padding: 12px;
            width: 100%;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            text-align: left;
        }

        #login-container button {
            font-size: 1.2rem;
            padding: 12px 20px;
            margin-top: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            background-color: #2563eb;
            width: 100%;
        }

        #login-container button:hover {
            opacity: 0.9;
        }

        #login-error {
            color: #dc2626;
            margin-top: 15px;
            height: 1.2rem;
        }

        /* --- 2. å¾Œå°æ§åˆ¶å° --- */
        #admin-panel {
            /* é è¨­éš±è—ï¼Œç™»å…¥å¾Œæ‰é¡¯ç¤º */
            display: none;
            padding-top: 0;
            max-width: 600px;
            margin: 0 auto;
        }

        #admin-panel h1 {
            font-size: 3rem;
            color: #dc2626;
            margin-bottom: 30px;
        }

        #number {
            font-size: 5rem;
            color: #2563eb;
            margin: 20px 0;
        }
        
        /* æ§åˆ¶ç¾¤çµ„ (ä½¿ç”¨ Flexbox å‚ç›´æ’åˆ—) */
        .control-group {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-wrap: wrap;
        }

        /* æ°´å¹³æ’åˆ—çš„æŒ‰éˆ•ç¾¤çµ„ (ç”¨æ–¼ ä¸Šä¸€è™Ÿ/ä¸‹ä¸€è™Ÿ) */
        .control-group.button-row {
            flex-direction: row;
            justify-content: center;
        }

        .control-group label {
            display: block;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 8px;
            font-weight: bold;
        }

        /* --- 3. æŒ‰éˆ• & è¼¸å…¥æ¡† --- */
        button {
            font-size: 1.2rem;
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            min-width: 120px;
            width: 90%;
            max-width: 300px;
        }

        .control-group.button-row button {
            width: auto;
            min-width: 120px;
        }

        input,
        textarea {
            font-size: 1.2rem;
            padding: 8px;
            width: 90%;
            max-width: 300px;
            text-align: center;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-top: 10px;
            box-sizing: border-box;
        }

        textarea {
            height: 80px;
            text-align: left;
            padding: 10px;
        }
        
        /* --- 4. é¡è‰²ä¸»é¡Œ --- */
        #prev { background-color: #ef4444; }
        #next { background-color: #10b981; }
        #setNumber { background-color: #2563eb; }
        #savePassedNumbers { background-color: #0891b2; }
        #saveFeaturedContents { background-color: #8b5cf6; } 

        /* --- 5. é‡ç½®å€åŸŸ --- */
        .reset-zone {
            margin-top: 40px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
        .reset-zone h3 {
            color: #555;
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: bold;
        }
        /* å–®é …é‡ç½®æŒ‰éˆ• (ç¥ç€è‰²) */
        .btn-reset-single {
            background-color: #d97706;
            font-size: 1rem;
            padding: 8px 15px;
            width: auto;
        }
        .btn-reset-single:hover {
            opacity: 0.9;
        }
        /* å…¨éƒ¨é‡ç½® (æ·±ç´…è‰²) */
        #resetAll {
            background-color: #7f1d1d;
            margin-top: 20px;
        }

        /* --- 6. RWD (éŸ¿æ‡‰å¼è¨­è¨ˆ) --- */
        @media (max-width: 768px) {
            body {
                padding: 20px 10px;
            }
            #login-container {
                margin: 30px auto;
                padding: 20px;
            }
            #admin-panel h1 {
                font-size: 2.2rem;
            }
            #number {
                font-size: 4rem;
            }
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h1>å¾Œå°ç®¡ç†ç™»å…¥</h1>
        <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" />
        <button id="login-button" type="button">ç™»å…¥</button>
        <p id="login-error"></p>
    </div>

    <div id="admin-panel">
        <h1>ç›®å‰è™Ÿç¢¼ï¼š<span id="number">0</span></h1>

        <div class="control-group button-row">
            <button id="prev" type="button">ä¸Šä¸€è™Ÿ</button>
            <button id="next" type="button">ä¸‹ä¸€è™Ÿ</button>
        </div>
        <div class="control-group">
            <input type="number" id="manualNumber" placeholder="è¼¸å…¥è™Ÿç¢¼" />
            <button id="setNumber" type="button">è¨­å®šè™Ÿç¢¼</button>
        </div>

        <div class="control-group">
            <label for="featuredEditorInput">ç·¨è¼¯ç²¾é¸é€£çµ (æ¯è¡Œä¸€ç­†)</label>
            <textarea id="featuredEditorInput" placeholder="æ ¼å¼ï¼š é€£çµæ–‡å­—,https://..."></textarea>
            <button id="saveFeaturedContents" type="button">å„²å­˜ç²¾é¸é€£çµ</button>
        </div>

        <div class="control-group">
            <label for="passedNumbersInput">æ‰‹å‹•ç·¨è¼¯éè™Ÿåˆ—è¡¨ (ç”¨é€—è™Ÿ,åˆ†éš”)</label>
            <textarea id="passedNumbersInput" placeholder="ä¾‹å¦‚ï¼š 5, 8, 12"></textarea>
            <button id="savePassedNumbers" type="button">å„²å­˜éè™Ÿåˆ—è¡¨</button>
        </div>

        <div class="reset-zone">
            <h3>--- é‡ç½®é¸é … ---</h3>
            <div class="control-group button-row">
                <button id="resetNumber" type="button" class="btn-reset-single">é‡ç½®è™Ÿç¢¼ (æ­¸0)</button>
                <button id="resetFeaturedContents" type="button" class="btn-reset-single">é‡ç½®ç²¾é¸é€£çµ</button>
                <button id="resetPassed" type="button" class="btn-reset-single">é‡ç½®éè™Ÿåˆ—è¡¨</button>
            </div>
            <button id="resetAll" type="button">ğŸ’¥ é‡ç½®æ‰€æœ‰ (å…¨éƒ¨æ­¸0)</button>
        </div>
    </div>

    <script>
        // --- 1. å…ƒç´ ç¯€é» (DOM) ---
        // æŠ“å–æ‰€æœ‰éœ€è¦äº’å‹•çš„ HTML å…ƒç´ 
        const loginContainer = document.getElementById("login-container");
        const adminPanel = document.getElementById("admin-panel");
        const passwordInput = document.getElementById("password-input");
        const loginButton = document.getElementById("login-button");
        const loginError = document.getElementById("login-error");
        
        const numberEl = document.getElementById("number");
        const passedNumbersInputEl = document.getElementById("passedNumbersInput");
        const featuredEditorInput = document.getElementById("featuredEditorInput");

        // --- 2. å…¨åŸŸè®Šæ•¸ ---
        // ç”¨æ–¼åœ¨è¨˜æ†¶é«”ä¸­å„²å­˜é©—è­‰é€šéçš„å¯†ç¢¼ (Token)
        let token = "";

        // --- 3. Socket.io ---
        // åˆå§‹åŒ– Socket.ioï¼Œä½†è¨­å®šç‚ºæ‰‹å‹•é€£ç·š
        // é€™æ¨£å¯ä»¥é¿å…åœ¨ç™»å…¥å‰å°±å˜—è©¦é€£ç·š
        const socket = io({ autoConnect: false });

        // --- 4. ç™»å…¥/é¡¯ç¤ºé‚è¼¯ ---
        
        /** é¡¯ç¤ºç™»å…¥ç•«é¢ (åŒæ™‚ä¹Ÿæ˜¯ç™»å‡ºå‡½å¼) */
        function showLogin() {
            loginContainer.style.display = "block";
            adminPanel.style.display = "none";
            // ç”±æ–¼æ²’æœ‰ localStorage ç™»å…¥ï¼Œæ­¤è™•åƒ…ç‚º UI åˆ‡æ›
            document.title = "å¾Œå°ç®¡ç† - ç™»å…¥";
            socket.disconnect(); // ä¸»å‹•æ–·é–‹é€£ç·š
        }

        /** é¡¯ç¤ºå¾Œå°æ§åˆ¶å° */
        function showPanel() {
            loginContainer.style.display = "none";
            adminPanel.style.display = "block";
            document.title = "å¾Œå°ç®¡ç† - æ§åˆ¶å°";
            socket.connect(); // ç™»å…¥æˆåŠŸå¾Œï¼Œæ‰é–‹å§‹é€£ç·š
        }

        /** [API] æª¢æŸ¥ Token æ˜¯å¦æœ‰æ•ˆ */
        async function checkToken(tokenToCheck) {
            if (!tokenToCheck) return false;
            try {
                const res = await fetch("/check-token", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token: tokenToCheck }),
                });
                return res.ok; // ä¼ºæœå™¨å›å‚³ 200-299 å³ç‚º true
            } catch (err) {
                console.error("checkToken å¤±æ•—:", err);
                return false;
            }
        }

        /** å˜—è©¦ç™»å…¥ */
        async function attemptLogin(tokenToCheck) {
            loginError.textContent = "é©—è­‰ä¸­...";
            const isValid = await checkToken(tokenToCheck);
            if (isValid) {
                token = tokenToCheck; // å°‡ Token å­˜å…¥è¨˜æ†¶é«”
                showPanel(); // é¡¯ç¤ºæ§åˆ¶å°
            } else {
                loginError.textContent = "å¯†ç¢¼éŒ¯èª¤";
                showLogin();
            }
        }

        /** é é¢è¼‰å…¥å®Œæˆæ™‚çš„å…¥å£ */
        document.addEventListener("DOMContentLoaded", () => {
            // æ¯æ¬¡è¼‰å…¥éƒ½é¡¯ç¤ºç™»å…¥ç•«é¢ (å› ç‚ºæ²’æœ‰ localStorage)
            showLogin();
        });

        // ç¶å®šç™»å…¥æŒ‰éˆ•é»æ“Šäº‹ä»¶
        loginButton.addEventListener("click", () => {
            attemptLogin(passwordInput.value);
        });
        // ç¶å®šå¯†ç¢¼æ¡† Enter éµ
        passwordInput.addEventListener("keyup", (event) => {
            if (event.key === "Enter") {
                attemptLogin(passwordInput.value);
            }
        });

        // --- 5. æ§åˆ¶å° Socket ç›£è½å™¨ ---
        
        // ç•¶ Socket é€£ç·šæˆåŠŸæ™‚
        socket.on("connect", () => {
            console.log("Socket.io å·²é€£æ¥");
        });
        
        // ç›£è½ä¾†è‡ªä¼ºæœå™¨çš„ 'update' äº‹ä»¶ï¼Œæ›´æ–°è™Ÿç¢¼
        socket.on("update", (num) => (numberEl.textContent = num));
        
        // ç›£è½ 'updatePassed'ï¼Œå°‡ä¼ºæœå™¨çš„éè™Ÿåˆ—è¡¨ (é™£åˆ—) è½‰ç‚ºæ–‡å­—ï¼Œå¡«å…¥ <textarea>
        socket.on("updatePassed", (numbers) => {
            if (numbers && Array.isArray(numbers)) {
                passedNumbersInputEl.value = numbers.join(", ");
            } else {
                passedNumbersInputEl.value = "";
            }
        });

        // ç›£è½ 'updateFeaturedContents'ï¼Œå°‡ä¼ºæœå™¨çš„é€£çµåˆ—è¡¨ (é™£åˆ—) è½‰ç‚ºæ–‡å­—ï¼Œå¡«å…¥ <textarea>
        socket.on("updateFeaturedContents", (contents) => {
            if (contents && Array.isArray(contents)) {
                const textValue = contents.map(item => 
                    `${item.linkText},${item.linkUrl}`
                ).join("\n");
                featuredEditorInput.value = textValue;
            } else {
                featuredEditorInput.value = "";
            }
        });

        // --- 6. API è«‹æ±‚å‡½å¼ ---
        /**
         * å‘¼å«å¾Œç«¯ API çš„é€šç”¨å‡½å¼
         * @param {string} endpoint - API è·¯å¾‘ (e.g., "/set-number")
         * @param {object} body - è¦å‚³é€çš„è³‡æ–™
         * @returns {boolean} - æ˜¯å¦æˆåŠŸ
         */
        async function apiRequest(endpoint, body) {
            try {
                const res = await fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    // è‡ªå‹•å°‡ Token æ³¨å…¥åˆ°æ‰€æœ‰è«‹æ±‚ä¸­
                    body: JSON.stringify({ ...body, token }),
                });
                
                // è™•ç†éŒ¯èª¤
                if (!res.ok) {
                    const errorData = await res.json();
                    if (res.status === 403) {
                        // 403 (Token éŒ¯èª¤æˆ–éæœŸ)ï¼Œå¼·åˆ¶ç™»å‡º
                        alert("å¯†ç¢¼é©—è­‰å¤±æ•—æˆ– Token å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
                        showLogin();
                    } else {
                        alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + (errorData.error || "æœªçŸ¥éŒ¯èª¤"));
                    }
                    return false;
                }
                return true; // API å‘¼å«æˆåŠŸ
            } catch (err) {
                alert("ç¶²è·¯é€£ç·šå¤±æ•—æˆ–ä¼ºæœå™¨ç„¡å›æ‡‰ï¼š" + err.message);
                return false;
            }
        }

        // --- 7. æ§åˆ¶å°æŒ‰éˆ•åŠŸèƒ½ ---
        // é€™äº›å‡½å¼éƒ½æœƒå‘¼å« apiRequest ä¾†èˆ‡ä¼ºæœå™¨æºé€š

        async function changeNumber(direction) {
            await apiRequest("/change-number", { direction });
        }
        
        async function setNumber() {
            const num = document.getElementById("manualNumber").value;
            if (num === "") return;
            const success = await apiRequest("/set-number", { number: num });
            if (success) {
                document.getElementById("manualNumber").value = "";
            }
        }
        
        async function savePassedNumbers() {
            const text = passedNumbersInputEl.value;
            // å°‡ <textarea> çš„æ–‡å­— (e.g., "5, 8, 12") è½‰ç‚º [5, 8, 12]
            const numbersArray = text.split(",")
                .map((n) => n.trim())
                .filter((n) => n.length > 0)
                .map((n) => Number(n));
                
            const success = await apiRequest("/set-passed-numbers", { numbers: numbersArray });
            if (success) {
                alert("éè™Ÿåˆ—è¡¨å·²å„²å­˜ã€‚");
            }
        }

        /** [ä¿®å¾©] å„²å­˜ç²¾é¸é€£çµ (æ”¾å¯¬éæ¿¾) */
        async function saveFeaturedContents() {
            const text = featuredEditorInput.value;
            // å°‡ <textarea> çš„æ–‡å­— (e.g., "Google,https://...") è½‰ç‚º [{linkText: 'Google', linkUrl: 'https://...'}]
            const contentsArray = text
                .split('\n')
                .map(line => {
                    if (line.trim() === '') return null; // å¿½ç•¥ç©ºè¡Œ
                    const parts = line.split(',');
                    return {
                        linkText: parts[0] ? parts[0].trim() : '',
                        linkUrl: parts[1] ? parts.slice(1).join(',').trim() : ''
                    };
                })
                .filter(Boolean); // éæ¿¾æ‰ç©ºè¡Œ (null)

            const success = await apiRequest("/set-featured-contents", { contents: contentsArray });
            if (success) {
                alert("ç²¾é¸é€£çµå·²å„²å­˜ã€‚");
            }
        }

        // --- é‡ç½®åŠŸèƒ½ ---
        async function resetNumber() {
            if (!confirm("ç¢ºå®šè¦å°‡ã€Œç›®å‰è™Ÿç¢¼ã€é‡ç½®ç‚º 0 å—ï¼Ÿ (æœƒå°‡ç¾æœ‰è™Ÿç¢¼åŠ å…¥éè™Ÿåˆ—è¡¨)")) return;
            // é‡ç½®è™Ÿç¢¼å°±æ˜¯å‘¼å« setNumber ä¸¦å‚³å…¥ 0
            const success = await apiRequest("/set-number", { number: 0 });
            if (success) {
                document.getElementById("manualNumber").value = "";
                alert("è™Ÿç¢¼å·²é‡ç½®ç‚º 0ã€‚");
            }
        }
        
        async function resetPassed() {
            if (!confirm("ç¢ºå®šè¦æ¸…ç©ºã€Œå·²å«è™Ÿç¢¼(éè™Ÿ)ã€åˆ—è¡¨å—ï¼Ÿ")) return;
            await apiRequest("/set-passed-numbers", { numbers: [] });
            // alert("éè™Ÿåˆ—è¡¨å·²æ¸…ç©ºã€‚"); // ä¼ºæœå™¨æœƒè‡ªå‹•å»£æ’­æ›´æ–°ï¼Œä¸ç”¨ alert
        }
        
        async function resetFeaturedContents() {
            if (!confirm("ç¢ºå®šè¦æ¸…ç©ºã€Œç²¾é¸é€£çµã€å—ï¼Ÿ")) return;
            const success = await apiRequest("/set-featured-contents", { contents: [] });
            if (success) {
                alert("ç²¾é¸é€£çµå·²æ¸…ç©ºã€‚");
            }
        }
        
        async function resetAll() {
            if (!confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰å…§å®¹å…¨éƒ¨é‡ç½®å—ï¼Ÿ")) { return; }
            const success = await apiRequest("/reset", {});
            if (success) {
                document.getElementById("manualNumber").value = "";
                alert("å·²å…¨éƒ¨é‡ç½®ã€‚");
            }
        }

        // --- 8. ç¶å®šæŒ‰éˆ•äº‹ä»¶ ---
        // å°‡ HTML å…ƒç´ çš„ onclick äº‹ä»¶ç¶å®šåˆ°å°æ‡‰çš„ JavaScript å‡½å¼
        document.getElementById("next").onclick = () => changeNumber("next");
        document.getElementById("prev").onclick = () => changeNumber("prev");
        document.getElementById("setNumber").onclick = setNumber;
        document.getElementById("savePassedNumbers").onclick = savePassedNumbers;
        document.getElementById("saveFeaturedContents").onclick = saveFeaturedContents;
        
        document.getElementById("resetNumber").onclick = resetNumber;
        document.getElementById("resetFeaturedContents").onclick = resetFeaturedContents;
        document.getElementById("resetPassed").onclick = resetPassed;
        document.getElementById("resetAll").onclick = resetAll;

    </script>
</body>
</html>
